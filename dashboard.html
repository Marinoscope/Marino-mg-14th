<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>集計を確認する</title>

  <style>
    :root{
      --bg:#EAF6F2;
      --card:#FFFFFF;
      --text:#1C2B2A;
      --muted:#4A6663;

      --pink:#F6B7C6;
      --green:#2F7D73;
      --green-soft:#CFE9E2;

      --border:#D7E7E2;
      --shadow: 0 10px 28px rgba(24, 74, 67, .10);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(246,183,198,.35), transparent 60%),
        radial-gradient(1200px 700px at 90% 10%, rgba(47,125,115,.18), transparent 60%),
        var(--bg);
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 16px 12px 28px; }
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin: 6px 2px 10px;
      font-size: 13px;
    }
    a{ color:#133B37; text-decoration:none; font-weight:700; }
    a:hover{ text-decoration:underline; }

    .title{
      display:flex; align-items:center; gap:10px;
      margin: 6px 2px 8px;
    }
    .logo{
      width: 40px; height: 40px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(246,183,198,.95), rgba(47,125,115,.35));
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.6);
    }
    h1{ font-size: 18px; margin: 0; }
    .sub{ margin: 4px 0 0; color: var(--muted); font-size: 12.5px; line-height: 1.6; }

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-top: 12px;
      backdrop-filter: blur(6px);
    }

    .hint{ font-size:12px; color: var(--muted); line-height:1.6; margin-top: 6px; }

    /* レジェンド */
    .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 10px; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(47,125,115,.18);
      background: rgba(207,233,226,.35);
      font-size: 12px;
      font-weight: 900;
      color:#153F3A;
    }
    .box{ width:16px; height:16px; border-radius:6px; border:1px solid rgba(0,0,0,.10); }

    .meta{ margin-top: 10px; font-size: 12px; color: var(--muted); font-weight: 800; }

    /* スマホ：日程カード表示 */
    .mobileOnly{ display:block; }
    .desktopOnly{ display:none; }

    @media (min-width: 900px){
      .wrap{ padding: 22px 16px 34px; }
      h1{ font-size: 22px; }
      .sub{ font-size: 13.5px; }
      .mobileOnly{ display:none; }
      .desktopOnly{ display:block; }
    }

    .dateCard{
      border:1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
      background: rgba(255,255,255,.96);
    }
    .dateHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-weight: 900;
      color:#163E3A;
      margin-bottom: 10px;
    }
    .slots{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    .slotCell{
      height: 22px;
      border-radius: 10px;
      border:1px solid rgba(0,0,0,.08);
    }
    .slotLabels{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-top: 8px;
      color:#2B4C48;
      font-size: 11px;
      font-weight: 900;
      text-align:center;
    }

    /* PC：表 */
    .grid{ overflow:auto; margin-top: 10px; border-radius: 16px; }
    table{ border-collapse:collapse; min-width: 860px; background: rgba(255,255,255,.96); }
    th, td{ border:1px solid rgba(0,0,0,.06); padding: 10px; text-align:center; }
    th{ background: rgba(207,233,226,.55); color:#0F3B35; position: sticky; top:0; z-index: 1; }
    td:first-child{ background: rgba(246,183,198,.20); text-align:left; font-weight: 900; position: sticky; left:0; z-index: 1; }

    .warnTitle{ font-weight: 900; color:#5A2A37; }
    ul{ margin: 8px 0 0 18px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <a href="./index.html">← 戻る</a>
      <a href="./report.html">報告する →</a>
    </div>

    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>合算の集計（濃淡のみ）</h1>
        <div class="sub">
          具体的な応募数は公開しません。濃いほど相対的に応募が多い枠です。<br/>
          落選は「その日程で落選報告があったか」を表の外にサマリー表示します。
        </div>
      </div>
    </div>

    <div class="card">
      <div id="mobile" class="mobileOnly"></div>

      <div id="desktop" class="desktopOnly">
        <div class="grid" id="grid"></div>
      </div>

      <div class="legend" id="legend"></div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="card">
      <div class="warnTitle">落選サマリー（完売の可能性が高い日程）</div>
      <div class="hint">
        ※「一部落選を含む落選あり」チェックの報告件数です（部の内訳・具体数は出しません）。
      </div>
      <div id="rej"></div>
    </div>
  </div>

  <script>
    /******************************************************************
     * 【設定値：埋め込み済み】
     ******************************************************************/
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzYwQKukRGZXb6yXrZhULmHdwvX2bmFs6Ka6UkJE52zoR27zWU1wxZaNXmqC3VFlQQY/exec";

    const SLOT_LABELS = ["第1部","第2部","第3部","第4部","第5部","第6部"];

    /******************************************************************
     * メイン：GASから summary を取得して描画
     ******************************************************************/
    async function main(){
      const res = await fetch(`${GAS_URL}?action=summary`, { cache: "no-store" });
      const data = await res.json().catch(() => null);

      if (!data || !data.ok) {
        document.getElementById("mobile").textContent = "読み込みに失敗しました。";
        document.getElementById("grid").textContent = "読み込みに失敗しました。";
        return;
      }

      renderMobile(data);
      renderDesktop(data);
      renderLegend();
      renderRejectionSummary(data);
      renderMeta(data);
    }

    /******************************************************************
     * 濃淡の色（0..1 → グレースケール）
     * - ここは好みで「緑寄り」にもできるけど、まずは見やすい無彩色で
     ******************************************************************/
    function shadeColor(v){
      const x = Math.max(0, Math.min(1, v || 0));
      const shade = Math.round(255 - (x * 180)); // 255..75
      return `rgb(${shade},${shade},${shade})`;
    }

    function formatDateJP(iso){
      const [y,m,d] = String(iso).split("-").map(Number);
      if (!y || !m || !d) return String(iso);
      return `${m}月${d}日`;
    }

    /******************************************************************
     * スマホ：日程カード（6部の濃淡バー）
     ******************************************************************/
    function renderMobile(data){
      const root = document.getElementById("mobile");
      root.innerHTML = "";

      const dates = data.dates || [];
      const intensity = data.intensity || [];

      for (let r=0; r<dates.length; r++){
        const card = document.createElement("div");
        card.className = "dateCard";

        const head = document.createElement("div");
        head.className = "dateHead";
        head.textContent = formatDateJP(dates[r]);

        const slots = document.createElement("div");
        slots.className = "slots";

        for (let c=0; c<6; c++){
          const v = (intensity[r] && typeof intensity[r][c] === "number") ? intensity[r][c] : 0;
          const cell = document.createElement("div");
          cell.className = "slotCell";
          cell.style.backgroundColor = shadeColor(v);
          slots.appendChild(cell);
        }

        const labels = document.createElement("div");
        labels.className = "slotLabels";
        for (let c=0; c<6; c++){
          const t = document.createElement("div");
          t.textContent = String(c+1);
          labels.appendChild(t);
        }

        card.appendChild(head);
        card.appendChild(slots);
        card.appendChild(labels);
        root.appendChild(card);
      }
    }

    /******************************************************************
     * PC：表（ヒートマップ）
     ******************************************************************/
    function renderDesktop(data){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      const dates = data.dates || [];
      const intensity = data.intensity || [];

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");

      const th0 = document.createElement("th");
      th0.textContent = "日程";
      trh.appendChild(th0);

      for (const s of SLOT_LABELS){
        const th = document.createElement("th");
        th.textContent = s;
        trh.appendChild(th);
      }

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      for (let r=0; r<dates.length; r++){
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateJP(dates[r]);
        tr.appendChild(tdDate);

        for (let c=0; c<6; c++){
          const v = (intensity[r] && typeof intensity[r][c] === "number") ? intensity[r][c] : 0;
          const td = document.createElement("td");
          td.style.backgroundColor = shadeColor(v);
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      grid.appendChild(table);
    }

    /******************************************************************
     * 凡例
     ******************************************************************/
    function renderLegend(){
      const legend = document.getElementById("legend");
      legend.innerHTML = "";

      const items = [
        { label: "薄い（相対的に少ない）", v: 0.0 },
        { label: "中", v: 0.5 },
        { label: "濃い（相対的に多い）", v: 1.0 },
      ];

      for (const it of items){
        const pill = document.createElement("div");
        pill.className = "pill";
        const box = document.createElement("div");
        box.className = "box";
        box.style.backgroundColor = shadeColor(it.v);
        const text = document.createElement("div");
        text.textContent = it.label;
        pill.appendChild(box);
        pill.appendChild(text);
        legend.appendChild(pill);
      }
    }

    /******************************************************************
     * 落選サマリー（表の外に表示）
     ******************************************************************/
    function renderRejectionSummary(data){
      const list = data.rejectionByDate || [];
      const rej = document.getElementById("rej");

      if (!list.length){
        rej.textContent = "現在、落選報告はありません。";
        return;
      }

      const sorted = [...list].sort((a,b) => String(a.date).localeCompare(String(b.date)));

      const ul = document.createElement("ul");
      for (const item of sorted){
        const li = document.createElement("li");
        li.textContent = `${formatDateJP(item.date)}：落選報告 ${item.reports}件あり`;
        ul.appendChild(li);
      }

      rej.innerHTML = "";
      rej.appendChild(ul);
    }

    function renderMeta(data){
      const meta = document.getElementById("meta");
      meta.textContent = `最終更新（集計生成時刻）：${new Date(data.updatedAt).toLocaleString("ja-JP")}`;
    }

    main();
  </script>
</body>
</html>
